<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: sysadmin | The Abigail Oath]]></title>
  <link href="http://deadc.org/blog/categories/sysadmin/atom.xml" rel="self"/>
  <link href="http://deadc.org/"/>
  <updated>2012-11-10T16:04:36-02:00</updated>
  <id>http://deadc.org/</id>
  <author>
    <name><![CDATA[deadc]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[MySQL Binary Logs: porque meu HD está cheio?]]></title>
    <link href="http://deadc.org/blog/2012/11/10/mysql-binary-logs-porque-meu-hd-esta-cheio/"/>
    <updated>2012-11-10T14:34:00-02:00</updated>
    <id>http://deadc.org/blog/2012/11/10/mysql-binary-logs-porque-meu-hd-esta-cheio</id>
    <content type="html"><![CDATA[<p>Se o diretório onde está alocado os arquivos data de seu MySQL está crescendo mais que o normal, possivelmente você está tendo problemas com a configuração quanto a flag que determina o uso dos binlogs.</p>

<p>Binlogs em sua essência são utilizados para realizar a replicação de bancos de dados e em algumas ocasiões te salvar quando algum dado é perdido, se você não realiza a replicação e tampouco se preocupa com o armazenamento dos binlogs, não existe sentido manter essa configuração.</p>

<p>Para desabilitar esta opção, comente a linha no seu <code>/etc/mysql/my.cnf</code> que diz <code>log-bin=mysql-bin</code> onde define que os binlogs devem ser criados e indica qual nome dos arquivos. Você ainda pode parar a geração dos binlogs <em>on-the-fly</em> utilizando o seguinte comando como usuario <strong>root</strong></p>

<pre>
mysql> SET GLOBAL SQL_LOG_BIN=0;
Query OK, 0 rows affected (0.00 sec)
</pre>


<p>Este comando na verdade não desabilita o binlogs e sim, ignora INSERTs, DDLs, UPDATEs, e DELETEs, para que a alteração seja permanente você ainda terá que editar o <code>/etc/mysql/my.cnf</code>.</p>

<p>Caso você faça uso dos binlogs, você ainda pode definir um tamanho e qual a frequencia de criação destes arquivos, ajustando de acordo com a necessidade do uso, utilizando as flags:</p>

<ul>
<li><p><strong>max_binlog_size</strong>: que define qual tamanho maximo do arquivo em kilobytes. quando atingir este valor será criado um novo arquivo sequencial no formato nome-do-arquivo.XXXXXX</p></li>
<li><p><strong>expire_logs_days</strong>: que define de quanto em quanto dias os binlogs serão removidos, recomenda-se utilizar o periodo minimo de 10 dias, dependendo do atraso entre o master e slave quando existir a replicação de bancos.</p></li>
<li><p><strong>binlog-ignore-db</strong>: que especifica quais databases podem ser ignoradas pelo binlog.</p></li>
<li><p><strong>binlog-do-db</strong>: que especifica quais databases devem ser monitoradas e os comandos salvos no binlog.</p></li>
</ul>


<p>Feita a configuração, e tendo certeza que os binlogs armazenados não são mais necessários, você poderá excluir todos os binlogs através do comando</p>

<pre>
mysql> RESET MASTER;
Query OK, 0 rows affected (0.00 sec)
</pre>


<p>ou se o mysqld estiver configurado como <code>SLAVE</code></p>

<pre>
mysql> RESET SLAVE;
Query OK, 0 rows affected (0.06 sec)
</pre>


<p>Você ainda poderá especificar quais binlogs devem ser removidos pela sequencia da criação dos arquivos</p>

<pre>
mysql> PURGE BINARY LOGS TO 'mysql-bin.000015';
Query OK, 0 rows affected (0.08 sec)
</pre>


<p>ou através da data de criação</p>

<pre>
mysql> PURGE BINARY LOGS BEFORE '20012-11-10 00:00:00';
Query OK, 0 rows affected (0.11 sec)
</pre>


<p>Ou mesmo utilizando o <code>mysqladmin</code> com o parametro <code>flush-logs</code>, que exclui qualquer binlog anterior a 3 dias</p>

<pre>
jazz//deadcow ~ % mysqladmin -u root flush-logs
</pre>


<p>A remoção dos binlogs devem ser realizadas através do proprio MySQL, remoções diretas podem causar efeitos inesperados no comportamento normal do serviço.</p>

<p>A geração de logs pelo mysqld pode ser util ao identificar problemas de performance, porém devem ser tratados com certa cautela para que uma solução não vire uma dor de cabeça. ainda existem outros fatores que podem contribuir para o aumento do uso do disco pelo mysqld e que serão abordados em outros posts no futuro.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[O mod_gzip está funcionando?]]></title>
    <link href="http://deadc.org/blog/2012/10/26/o-mod-gzip-esta-funcionando/"/>
    <updated>2012-10-26T17:58:00-02:00</updated>
    <id>http://deadc.org/blog/2012/10/26/o-mod-gzip-esta-funcionando</id>
    <content type="html"><![CDATA[<p>Um jeito simples de verificar se seu site está realmente enviando paginas comprimidas para o cliente, sem ter que instalar um plugin no seu browser é utilizar o parametro <code>--header</code> do wget.</p>

<p><blockquote><p>--header=header-line</p></p><p><pre><code>Send header-line along with the rest of the headers in each HTTP request.  The supplied header is sent as-is, which means it must contain name and value separated by colon, and must not contain newlines.<br/></code></pre></p><p><p></p><footer><strong>man wget</strong> <cite>Retirado Do Manual Pages</cite></footer></blockquote></p>

<p>Passando ao parametro <code>--header</code> do wget <code>Accept-Encoding: gzip</code> é possivel baixar a página comprimida, claro se o servidor tiver esta opção</p>

<pre>
deadcow@jazz ~ $ wget --header='Accept-Encoding: gzip' \
http://www.uol.com.br -O sample.gz
--2012-10-26 18:07:56--  http://www.uol.com.br/
Resolving www.uol.com.br... 200.221.2.45, 200.147.67.142
Connecting to www.uol.com.br|200.221.2.45|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: unspecified [text/html]
Saving to: ‘sample.gz’

    [  <=>                               ] 86,339       211KB/s   in 0.4s

2012-10-26 18:07:57 (211 KB/s) - ‘sample.gz’ saved [86339]

deadcow@jazz ~ $ file sample.gz
sample.gz: gzip compressed data, from Unix
deadcow@jazz ~ $
</pre>


<p>Já se o servidor não oferece este recurso, o comando <code>file</code> retornará uma página html normal</p>

<pre>
deadcow@jazz ~ $ wget --header='Accept-Encoding: gzip' \
http://www.blunt.com.br -O sample.gz
--2012-10-26 18:08:17--  http://www.blunt.com.br/
Resolving www.blunt.com.br... 216.14.115.179
Connecting to www.blunt.com.br|216.14.115.179|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: unspecified [text/html]
Saving to: ‘sample.gz’

    [     <=>                            ] 45,874      53.6KB/s   in 0.8s

2012-10-26 18:08:19 (53.6 KB/s) - ‘sample.gz’ saved [45874]

deadcow@jazz ~ $ file sample.gz
sample.gz: HTML document, ISO-8859 text, with very long lines, \
with CR, LF line terminators
deadcow@jazz ~ $
</pre>


<p>Além do <code>Accept-Encoding: gzip</code>, você pode passar qualquer parametro para o servidor, substituindo os valores padrões do wget, muito util para testar alguns redirecionamentos</p>

<pre>
deadcow@jazz ~ $ wget --header='Host: ig.com.br' \
http://www.uol.com.br
--2012-10-26 18:14:45--  http://www.uol.com.br/
Resolving www.uol.com.br... 200.221.2.45, 200.147.67.142
Connecting to www.uol.com.br|200.221.2.45|:80... connected.
HTTP request sent, awaiting response... 302 Found
Location: http://www.uol.com.br/ [following]
[...]
Connecting to www.uol.com.br|200.221.2.45|:80... connected.
HTTP request sent, awaiting response... 302 Found
Location: http://www.uol.com.br/ [following]
--2012-10-26 18:14:47--  http://www.uol.com.br/
Connecting to www.uol.com.br|200.221.2.45|:80... connected.
HTTP request sent, awaiting response... 302 Found
Location: http://www.uol.com.br/ [following]
20 redirections exceeded.
deadcow@jazz ~ $
</pre>


<p>Dica retirada do site <a href="http://www.cyberciti.biz/faq/unix-linux-wget-download-compressed-gzip-headers">nixcraft</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The Abigail Oath]]></title>
    <link href="http://deadc.org/blog/2012/10/21/the-abigail-oath/"/>
    <updated>2012-10-21T15:55:00-02:00</updated>
    <id>http://deadc.org/blog/2012/10/21/the-abigail-oath</id>
    <content type="html"><![CDATA[<p><blockquote><p></p></p><p><p>I am hired because I know what I am doing, not because I will do whatever I am told is a good idea.</p></p><p><p>This might cost me bonuses, raises, promotions, and may even label me as "undesirable" by places I don’t want to work at anyway, but I don’t care.</p></p><p><p>I will not compromise my own principles and judgement without putting up a fight.</p></p><p><p>Of course, I won’t always win, and I will sometimes be forced to do things I don’t agree with. My objections will be made known.</p></p><p><p>If I am shown to be right and problems later develop, I will shout "I told you so!" repeatedly, laugh hysterically, and do a small dance or jig as appropriate to my heritage.</p></p><p><p></p><footer><strong>Mike Sphar</strong> <cite><a href='http://groups.google.com/group/alt.sysadmin.recovery/msg/1d05c6aa3681e609?output=gplain'>Re: Abigail's Resignation Letter</a></cite></footer></blockquote></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SSH Tips: ssh-agent vs. ssh_config]]></title>
    <link href="http://deadc.org/blog/2012/10/20/ssh-tips-ssh-agent-vs-ssh-config/"/>
    <updated>2012-10-20T18:17:00-03:00</updated>
    <id>http://deadc.org/blog/2012/10/20/ssh-tips-ssh-agent-vs-ssh-config</id>
    <content type="html"><![CDATA[<p>Muitas vezes utilizamos chaves privadas para acessar servidores remotos via ssh, principalmente agora com a utilização de autenticações somente por chave como por exemplo a Engine Yard, que roda em cima do PaaS da amazon (AWS).</p>

<p>A maioria das pessoas costuma utilizar o <code>ssh-agent</code> como gerenciador dessas chaves, quase todos os tutoriais passo-a-passo a respeito de acesso remoto via ssh sem a utilização de senhas mencionam ele.</p>

<p>O problema é que nem todas as distribuições oferecem ele como pacote padrão, além disso, o ssh-agent adiciona apenas uma vez a chave a sessão, ele não vai requerer novamente a senha caso exista, isto pode ser visto como um problema de segurança.</p>

<p>Uma alternativa ao ssh-agent que pouca gente conhece é a associação do host destino a uma chave através do ssh_config, cada usuário tem a opção de criar um ssh_config próprio, para determinar o comportamento do cliente ssh.</p>

<p>Por padrão, o cliente ssh irá buscar a chave no caminho <code>~/.ssh/id_rsa</code> e <code>~/.ssh_dsa</code> para hosts que utilizem a versão 2 do protocolo ssh ou <code>~/.ssh/identity</code> para hosts que utilizem o protocolo 1, para alterar este comportamento definindo um arquivo para cada host, edite ou crie o arquivo <code>~/.ssh/config</code> adicionando as linhas:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>~/.ssh/config </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Host ssh.deadc.org
</span><span class='line'>  IdentityFile ~/.ssh/id_rsa-deadc.org</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>sendo que o arquivo <code>id_rsa-deadc.org</code> é a nossa chave que utilizaremos para acesso o servidor remoto, além de definir uma chave para cada host, é possivel definir também para um grupo de host:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>~/.ssh/config </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Host *.deadc.org
</span><span class='line'>  IdentityFile ~/.ssh/id_rsa-deadc.org</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>ou mesmo para todos os hosts:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>~/.ssh/config </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Host *
</span><span class='line'>  IdentityFile ~/.ssh/id_rsa-deadc.org</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Você poderá especificar mais de uma chave para cada host, cada chave será enviada para o servidor em sequencia, além disso, caso o ssh-agent esteja rodando e contenha alguma outra chave, ela também será enviada ao host na tentativa de se autenticar com o servidor. leia o <code>man ssh_config</code> para mais opções e informações a respeito.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MySQL: Binlogs Backup full e incremental]]></title>
    <link href="http://deadc.org/blog/2012/10/20/mysql-binlogs-backup-full-e-incremental/"/>
    <updated>2012-10-20T15:11:00-03:00</updated>
    <id>http://deadc.org/blog/2012/10/20/mysql-binlogs-backup-full-e-incremental</id>
    <content type="html"><![CDATA[<p>Mysql binlogs são logs de todos os comandos enviados para o mysql, ele captura todos os comandos executados, desde um simples INSERT até um DROP DATABASE e insere indices atraves de datas e numeros sequenciais. É uma ferramenta muito poderosa, utilizada na replicação de banco de dados e também na realização de backups incrementais.</p>

<p>Por padrão, diversas distribuições linux deixam essa opção desabilitada nos pacotes tradicionais do mysql-server, se este for o caso da sua instalação, habilite o binlog no seu servidor</p>

<p>Liquid error: ClassNotFound: no lexer for alias 'cnf' found</p>

<p>O <code>expire_logs_days</code> é a quantidade de dias que os bin-logs devem permanecer no servidor antes que sejam deletados, já na primeira linha, indica onde os bin-logs serão salvos, neste caso em <code>/var/lib/mysql</code>, é uma boa idéia separar a pasta onde os arquivos serão salvos caso você deseje realizar o backup incremental.</p>

<pre>
[root@jazz ~]# ls -la /var/lib/mysql/mysql-bin.*
-rw-rw---- 1 mysql mysql 27287 Jul 15 15:02 /var/lib/mysql/mysql-bin.000001
-rw-rw---- 1 mysql mysql 35873 Jul 15 15:02 /var/lib/mysql/mysql-bin.000002
-rw-rw---- 1 mysql mysql   107 Jul 15 15:03 /var/lib/mysql/mysql-bin.000003
-rw-rw---- 1 mysql mysql    57 Jul 15 15:03 /var/lib/mysql/mysql-bin.index
[root@jazz ~]#
</pre>


<p>Embora no diretorio destino exista mais de um binlog, apenas um está ativo no momento, você pode verificar qual e em qual posição o mesmo se encontra executando o seguinte comando:</p>

<pre>
deadcow@jazz ~ $ mysql -u root -e 'SHOW MASTER STATUS;'
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000003 |      107 |              |                  |
+------------------+----------+--------------+------------------+
deadcow@jazz ~ $
</pre>


<p>Agora iremos criar uma database para exemplificar o uso do binlog
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">bk_test</span><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'><span class="n">USE</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">bk_test</span><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">bk_test_t1</span><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;`</span><span class="n">id</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
</span><span class='line'><span class="o">`</span><span class="n">test_field</span><span class="o">`</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'><span class="o">`</span><span class="n">time_created</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
</span><span class='line'><span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
e então inserir algumas entradas
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">USE</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">bk_test</span><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'><span class="k">INSERT</span> <span class="k">into</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">bk_test_t1</span><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">test_field</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;val1&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">INSERT</span> <span class="k">into</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">bk_test_t1</span><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">test_field</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;val2&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">INSERT</span> <span class="k">into</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">bk_test_t1</span><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">test_field</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;val3&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
Agora temos um banco de dados ativo com entradas validas para a realização de um backup, primeiro iremos realizar um full backup em nosso banco</p>

<pre>
mysqldump -uroot -p --all-databases --single-transaction --flush-logs \
--master-data=2 > full_backup.sql
</pre>


<p>A flag <code>–flush-logs</code> é utilizada para que o binlog ativo seja fechado e um novo seja criado, <code>–master-data=2</code> adiciona comentários no dump com os indices do binlog, já a flag <code>–single-transaction</code> é utilizada para a realização consistente de dumps de bancos InnoDB, para quem não está familiarizado, uma forma simples de explicar uma transaction é dizer que é um unico comando, caso alguma entrada falhe, o comando inteiro será descartado e nenhuma alteração será feita no banco.</p>

<pre>
[root@jazz ~]# ls -la /var/lib/mysql/mysql-bin.*
-rw-rw---- 1 mysql mysql 27287 Jul 15 15:02 /var/lib/mysql/mysql-bin.000001
-rw-rw---- 1 mysql mysql 35873 Jul 15 15:02 /var/lib/mysql/mysql-bin.000002
-rw-rw---- 1 mysql mysql  1208 Jul 15 15:13 /var/lib/mysql/mysql-bin.000003
-rw-rw---- 1 mysql mysql    57 Jul 15 15:03 /var/lib/mysql/mysql-bin.index
[root@jazz ~]# mysqldump -uroot -p --all-databases --single-transaction \
> --flush-logs --master-data=2 > full_backup.sql
Enter password:
[root@jazz ~]# ls -la /var/lib/mysql/mysql-bin.*
-rw-rw---- 1 mysql mysql 27287 Jul 15 15:02 /var/lib/mysql/mysql-bin.000001
-rw-rw---- 1 mysql mysql 35873 Jul 15 15:02 /var/lib/mysql/mysql-bin.000002
-rw-rw---- 1 mysql mysql  1251 Jul 15 15:26 /var/lib/mysql/mysql-bin.000003
-rw-rw---- 1 mysql mysql   107 Jul 15 15:26 /var/lib/mysql/mysql-bin.000004
-rw-rw---- 1 mysql mysql    76 Jul 15 15:26 /var/lib/mysql/mysql-bin.index
[root@jazz ~]#
</pre>


<p>Agora iremos adicionar algumas entradas novas ao banco para exemplificar o backup incremental
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">USE</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">bk_test</span><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'><span class="k">INSERT</span> <span class="k">into</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">bk_test_t1</span><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">test_field</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;val4&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">INSERT</span> <span class="k">into</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">bk_test_t1</span><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">test_field</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;val5&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">INSERT</span> <span class="k">into</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">bk_test_t1</span><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">test_field</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;val6&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
Como realizamos o flush-logs no backup full, as novas entradas devem estar no arquivo mysql-bin.000004, para realizarmos o backup incremental de forma consistente, precisamos iniciar um novo binlog e copiar o arquivo (ou arquivos) para outra localidade, para iniciar um novo binlog execute</p>

<pre>
[root@jazz ~]# mysqladmin -uroot -p flush-logs
[root@jazz ~]# ls -la /var/lib/mysql/mysql-bin.*
-rw-rw---- 1 mysql mysql 27287 Jul 15 15:02 /var/lib/mysql/mysql-bin.000001
-rw-rw---- 1 mysql mysql 35873 Jul 15 15:02 /var/lib/mysql/mysql-bin.000002
-rw-rw---- 1 mysql mysql  1251 Jul 15 15:26 /var/lib/mysql/mysql-bin.000003
-rw-rw---- 1 mysql mysql   885 Jul 15 15:38 /var/lib/mysql/mysql-bin.000004
-rw-rw---- 1 mysql mysql   107 Jul 15 15:38 /var/lib/mysql/mysql-bin.000005
-rw-rw---- 1 mysql mysql    95 Jul 15 15:38 /var/lib/mysql/mysql-bin.index
[root@jazz ~]#
</pre>


<p>Agora temos os componentes para realizar um restore a partir de um backup full e um incremental, nosso banco agora está desta forma</p>

<pre>
mysql> USER bk_test;
Database changed

mysql> SHOW TABLES;
+-------------------+
| Tables_in_bk_test |
+-------------------+
| bk_test_t1        |
+-------------------+
1 row in set (0.00 sec)

mysql> SELECT * FROM bk_test_t1;
+----+------------+---------------------+
| id | test_field | time_created        |
+----+------------+---------------------+
| 1  | val1       | 2012-07-15 15:13:53 |
| 2  | val2       | 2012-07-15 15:13:53 |
| 3  | val3       | 2012-07-15 15:13:54 |
| 4  | val4       | 2012-07-15 15:33:50 |
| 5  | val5       | 2012-07-15 15:33:50 |
| 6  | val6       | 2012-07-15 15:33:52 |
+----+------------+---------------------+
6 rows in set (0.00 sec)

mysql>
</pre>


<p>Digamos agora que acidentalmente a database que utilizamos foi completamente removida</p>

<pre>
mysql> DROP DATABASE bk_test;
Query OK, 1 row affected (0.00 sec)

mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| test               |
+--------------------+
4 rows in set (0.00 sec)

mysql>
</pre>


<p>Tudo bem! temos o backup full e estamos a salvo certo?!</p>

<pre>
deadcow@jazz ~ $ mysql -u root < full_backup.sql
deadcow@jazz ~ $ mysql -u root
mysql> use bk_test;
Database changed

mysql> SELECT * FROM bk_test_t1;
+----+------------+---------------------+
| id | test_field | time_created        |
+----+------------+---------------------+
| 1  | val1       | 2012-07-15 15:13:53 |
| 2  | val2       | 2012-07-15 15:13:53 |
| 3  | val3       | 2012-07-15 15:13:54 |
+----+------------+---------------------+
3 rows in set (0.00 sec)

mysql>
</pre>


<p>Este backup não está completo, havia 6 entradas e agora só existem 3, mas ainda temos o backup incremental de um periodo posterior ao backup full, vamos aplica-lo</p>

<pre>
[root@jazz ~]# cd /var/lib/mysql/
[root@jazz mysql]# mysqlbinlog mysql-bin.000004 | mysql -u root bk_test
[root@jazz mysql]# mysql -u root bk_test

mysql> SELECT * FROM bk_test_t1;
+----+------------+---------------------+
| id | test_field | time_created        |
+----+------------+---------------------+
| 1  | val1       | 2012-07-15 15:13:53 |
| 2  | val2       | 2012-07-15 15:13:53 |
| 3  | val3       | 2012-07-15 15:13:54 |
| 4  | val4       | 2012-07-15 15:33:50 |
| 5  | val5       | 2012-07-15 15:33:50 |
| 6  | val6       | 2012-07-15 15:33:52 |
+----+------------+---------------------+
6 rows in set (0.00 sec)

mysql>
</pre>


<p>E tudo está recuperado, sem dores de cabeça. a ferramenta <code>mysqlbinlog</code> acompanha o pacote de instalação do <code>mysql-server</code>, ela retorna os comandos do binlog em plaintext e através dela é possivel recuperar o banco de dados, também pode se redirecionar a saida do programa para um arquivo e então editá-lo para excluir queries destrutivas antes de executar no mysql.</p>

<p>Além disso é possivel passar como parametro um periodo especifico de tempo para o mysqlbinlog, é muito util para recuperar pequenas quantidades de entradas perdidas em um banco de dados, desde que se conheca o periodo.</p>

<pre>
mysqlbinlog --start-datetime="2012-07-15 15:13:53" \ 
--stop-datetime="2012-07-15 15:13:54" mysql-bin.000004|mysql -uroot bk_test
</pre>


<p>Existem outras dezenas de possibilidades no MySQL que poucas pessoas conhecem, procure blogs, assine feeds e procure crescer profissionalmente através do seu conhecimento, facilite sua vida e a da sua empresa!</p>

<p>Referencias:</p>

<ul>
<li><a href="http://planet.mysql.com">Planet MySQL</a></li>
<li><a href="http://www.bytetouch.com/blog/system-administration/mysql-backup-and-point-in-time-recovery-with-binary-logs">Mysql Backup and point in time recovery with-binary logs</a></li>
<li><a href="http://www.mysqlperformanceblog.com/2012/01/18/backing-up-binary-log-files-with-mysqlbinlog">Backing up binary log files with mysqlbinlog</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
